<script src="js/utils.js"></script>
<script src="js/router/student.router.js"></script>
<script src="js/api/course.js"></script>
<script src="js/api/index.js"></script>
<div class="container student-container" style="display: none">
    <link rel="stylesheet" href="css/courseSelection.css">
    <div class="row">
        <table class="table-bordered-l text-center w-95" style="table-layout: fixed;word-break: break-all">
            <thead>
            <tr>
                <th class="tip">周次/节次</th>
                <th class="day">星期日</th>
                <th class="day">星期一</th>
                <th class="day">星期二</th>
                <th class="day">星期三</th>
                <th class="day">星期四</th>
                <th class="day">星期五</th>
                <th class="day">星期六</th>
            </tr>
            </thead>
            <tbody>

            <tr>
                <th class="tip">第一节</th>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
            </tr>
            <tr>
                <th class="tip">第二节</th>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
            </tr>
            <tr>
                <th class="tip">第三节</th>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
            </tr>
            <tr>
                <th class="tip">第四节</th>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
            </tr>
            <tr>
                <th class="tip">第五节</th>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
            </tr>
            <tr>
                <th class="tip">第六节</th>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
            </tr>
            <tr>
                <th class="tip">第七节</th>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
            </tr>
            <tr>
                <th class="tip">第八节</th>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
            </tr>
            <tr>
                <th class="tip">第九节</th>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
            </tr>
            <tr>
                <th class="tip">第十节</th>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
            </tr>
            <tr>
                <th class="tip">第十一节</th>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
            </tr>
            <tr>
                <th class="tip">第十二节</th>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
            </tr>
            <tr>
                <th class="tip">第十三节</th>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
            </tr>
            <tr>
                <th class="tip">第十四节</th>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
                <td class="time_slot"></td>
            </tr>
            </tbody>
        </table>
    </div>
    <div class="row">
        <div class="panel-group w-95">
            <div class="panel panel-primary">
                <div class="panel panel-body">
                    <form class="form-inline mb-10">
                        <div class="form-group">
                            <label class="ml-20">课程编号</label>
                            <input type="text" class="form-control" name="course_sec" id="course_sec" placeholder="课程编号" >

                            <label class="ml-20">课程名</label>
                            <input type="text" class="form-control" name="title" id="title" placeholder="课程名">

                            <label class="ml-20">开课院系</label>
                            <input type="text" class="form-control" name="dept_name" id="dept_name" placeholder="开课院系">
                            <a class="btn btn-success ml-20" id="search_link">查 询</a>

                        </div>
                    </form>
                    <table class="table table-bordered table-hover table-check text-center">
                        <thead>
                        <tr class="success">
                            <th>课程编号</th>
                            <th>课程名</th>
                            <th>任课教师</th>
                            <th>上课时间</th>
                            <th>开课院系</th>
                            <th>教室</th>
                            <th>课程考核</th>
                            <th>选课上限</th>
                            <th>学分</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody id="search_body">
                        <tr>
                            <td>ATMO130001.01</td>
                            <td>大气动力学基础</td>
                            <td>吴志伟</td>
                            <td>星期二 4-5</td>
                            <td>大气与海洋科学系</td>
                            <td>JA306</td>
                            <td>论文 星期五[18]</td>
                            <td>25</td>
                            <td>4</td>
                            <td><a href="javascript:void(0)" class="selection hover-underline">选课</a></td>
                        </tr>
                        <tr>
                            <td>ATMO130001.01</td>
                            <td>大气动力学基础</td>
                            <td>吴志伟</td>
                            <td>星期二 4-5</td>
                            <td>大气与海洋科学系</td>
                            <td>JA306</td>
                            <td>论文 星期五[18]</td>
                            <td>25</td>
                            <td>4</td>
                            <td><a href="javascript:void(0)" class="selection hover-underline">选课</a></td>
                        </tr>
                        <tr>
                            <td>ATMO130001.01</td>
                            <td>大气动力学基础</td>
                            <td>吴志伟</td>
                            <td>星期二 4-5</td>
                            <td>大气与海洋科学系</td>
                            <td>JA306</td>
                            <td>论文 星期五[18]</td>
                            <td>25</td>
                            <td>4</td>
                            <td><a href="javascript:void(0)" class="selection hover-underline">选课</a></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <nav class="pull-right" id="pagination">
                    <ul class="pagination pagination-sm">
                        <li class="disabled">
                            <a href="#" aria-label="Previous">
                                <span aria-hidden="true">«</span>
                            </a>
                        </li>
                        <li class="active"><a href="#">1</a></li>
                        <li><a href="#">2</a></li>
                        <li><a href="#">3</a></li>
                        <li><a href="#">4</a></li>
                        <li><a href="#">5</a></li>
                        <li>
                            <a href="#" aria-label="Next">
                                <span aria-hidden="true">»</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div><!-- end of panel -->
        </div>

        <script>
            $(function(){
                let section ={'title':'大气动力学基础','day':'5','course_id':'ATMO130001','section_id':'1',
                    'instructor_name':'吴志伟','time':'3-4','classroom_no':'JA306','lesson':'2'};
                addSectionToTable(section);
                section ={'title':'智能系统原理与开发','day':'1','course_id':'SOFT130001','section_id':'1',
                    'instructor_name':'吴斌','time':'11-12','classroom_no':'Z2204','lesson':'2'};
                addSectionToTable(section);
                section ={'title':'计算机前沿讲座','day':'5','course_id':'SOFT130001','section_id':'1',
                    'instructor_name':'赵一鸣','time':'6-7','classroom_no':'Z2306','lesson':'3'};
                setTimeout(function () {
                    removeSectionFromTable(section)
                },2000)
                addSectionToTable(section);
                getMyCourse();
                search();
                bindEVents();
            });
            function addSectionToTable(section) {
                let day = parseInt(section['day']);
                let start = parseInt(section['time'].split('-')[0]);
                let lesson = parseInt(section['lesson']);
                let html_course_result_str = '{title} </br> ({course_id}.0{section_id}) </br> ({instructor_name})</br> ({classroom_no})';
                let section_html = html_course_result_str.format(section);
                let start_ele_idx = (start - 1) * 7 + (day % 7);
                let jq_str = '.time_slot';
                $($(jq_str)[start_ele_idx]).html(section_html).attr('rowspan',lesson).addClass('bgc-blue').css('display','table-cell');
                for(let i = lesson - 1; i >= 1; i--){
                    $($(jq_str)[(start - 1 + i) * 7 + (day % 7)]).css('display','none')
                }

            }
            function removeSectionFromTable(section) {
                let day = parseInt(section['day']);
                let start = parseInt(section['time'].split('-')[0]);
                let lesson = parseInt(section['lesson']);
                let start_ele_idx = (start - 1) * 7 + (day % 7);
                let jq_str = '.time_slot';
                $($(jq_str)[start_ele_idx]).html('').attr('rowspan',1).removeClass('bgc-blue');
                for(let i = lesson - 1; i >= 1; i--){
                    $($(jq_str)[(start - 1 + i) * 7 + (day % 7)]).css('display','table-cell')
                }
            }
            function getMyCourse() {
                let params = {'user_id': getCookie('user_id')};
                $.when(getMyCourses(params))
                    .done(function (res) {
                        console.log(res.status, res.data);
                        if(res.status === 200){
                            for(let i=0; i < parseInt(res.data['total_num']); i++){
                                let section = res.data['sections'][i];
                                let html_section = html_course_result_str.format(section)
                                console.log(html_section)
                            }
                        }
                    })
            }
            function select(data) {
                $.when(selectCourse(data))
                    .done(function (res) {
                        console.log(res)
                    })
            }
            function search() {
                let html_search_result_str = '                        <tr>\n' +
                    '                            <td>{course_id}.{section_id}</td>\n' +
                    '                            <td>{title}</td>\n' +
                    '                            <td>{instructor_name}</td>\n' +
                    '                            <td>{time}/td>\n' +
                    '                            <td>{dept_name}</td>\n' +
                    '                            <td>{classroom_no}</td>\n' +
                    '                            <td>{exam}</td>\n' +
                    '                            <td>{limit}</td>\n' +
                    '                            <td>{credits}</td>\n' +
                    '                            <td><a href="javascript:void(0)" class="selection hover-underline" id="{course_id}.{section_id}">选课</a></td>\n' +
                    '                        </tr>';
                let day2time = {'1': '星期一', '2': '星期二','3': '星期三','4': '星期四','5': '星期五','6': '星期六','7': '星期天'};
                let search_params = {};
                let course_sec = $("#course_sec").val();
                let splits = course_sec.split('.');
                search_params['course_id'] = splits[0];
                if(splits.length > 1){
                    search_params['section_id'] = splits[1];
                }
                search_params['dept_name'] = $('#dept_name').val();
                search_params['page_num'] = $($('.pagination .active a')[0]).html();
                $.when(searchCourse(search_params))
                    .done(function (res) {
                        console.log(res.status, res.data);
                        if(res.status === 200 && 'sections' in res.data) {
                            let html_search_result = '';
                            for(let i=0; i < parseInt(res.data['total_num']); i++){
                                let section = res.data['sections'][i];
                                section['time'] = day2time[section['day']]  + '  ' + section['time'];
                                html_search_result += html_search_result_str.format(section);
                            }
                            console.log(html_search_result);
                            $("#search_body").html(html_search_result);
                        }
                    })
            }
            function bindEVents() {
                $("#search_link").click(function () {
                    search()
                });
                $(".selection").click(function () {
                    let course_sec = $(this).attr('id');
                    let splits = course_sec.split('.');
                    let params = {'user_id': getCookie('user_id'),'course_id':splits[0],'section_id':splits[1]};
                    select(params);
                })
            }
        </script>
    </div>
</div>